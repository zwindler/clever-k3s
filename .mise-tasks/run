#!/bin/bash

# Main script to setup and run Kubernetes cluster
set -e

# Export environment variables
export K8S_VERSION=1.33.2
export ETCD_VERSION=3.5.18
export ARCH=amd64

echo "ğŸš€ Starting Kubernetes cluster setup..."
echo "Kubernetes version: $K8S_VERSION"
echo ""

# Step 1: Setup binaries and tools
echo "ğŸ“¦ Step 1: Setting up binaries..."
./setup-binaries.sh

echo ""

# Step 2: Generate certificates
echo "ğŸ” Step 2: Generating certificates..."
./generate-certs.sh

echo ""

# Step 3: Setup kubeconfig
echo "âš™ï¸  Step 3: Setting up kubeconfig..."
./setup-kubeconfig.sh

echo ""

# Step 4: Start etcd
echo "ğŸ’¾ Step 4: Starting etcd..."
./start-etcd.sh

echo ""

# Step 5: Start control plane
echo "ğŸ›ï¸  Step 5: Starting control plane..."
./start-control-plane.sh

echo ""

# Step 6: Setup RBAC for worker nodes
echo "ğŸ”’ Step 6: Setting up RBAC for worker nodes..."
./setup-node-rbac.sh

echo ""

# Step 7: Generate bootstrap token
echo "ğŸ”‘ Step 7: Generating bootstrap token..."
./generate-bootstrap-token.sh

echo ""

# Step 8: Generate worker setup script
echo "ğŸ“ Step 8: Generating worker setup script..."
./generate-worker-script.sh

echo ""

# Step 9: Start additional services
echo "ğŸŒ Step 9: Starting additional services..."
./start-services.sh

echo ""
echo "âœ… Kubernetes cluster setup complete!"
echo ""
echo "ğŸ”— Available endpoints:"
echo "  â€¢ Kubernetes API: https://127.0.0.1:4040"
echo "  â€¢ HTTP Server: http://0.0.0.0:8080"
echo ""
echo "ğŸ“‹ To add worker nodes:"
echo "  1. Check the generated setup-worker-node.sh script"
echo "  2. Copy it to your external worker node"
echo "  3. Edit NODE_NAME and NODE_IP in the script"
echo "  4. Run it with sudo privileges"
echo ""
echo "ğŸ” Check cluster status:"
echo "  bin/kubectl get nodes"
echo "  bin/kubectl cluster-info"

# Keep the script running
wait

